// Generated by CoffeeScript 1.10.0
(function() {
  var XbmcApi, debug, defer, pubsub,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  defer = require('node-promise').defer;

  debug = require('debug')('xbmc:XbmcApi');

  pubsub = require('./PubSub');

  XbmcApi = (function() {
    function XbmcApi(options1) {
      this.options = options1 != null ? options1 : {};
      this.disconnect = bind(this.disconnect, this);
      this.connect = bind(this.connect, this);
      this.message = bind(this.message, this);
      this.send = bind(this.send, this);
      this.initialize = bind(this.initialize, this);
      this.setConnection = bind(this.setConnection, this);
      this.loadModules = bind(this.loadModules, this);
      debug('constructor');
      this.queue = [];
      this.connection = null;
      this.pubsub = pubsub;
      this.loadModules();
      pubsub.on('connection:open', (function(_this) {
        return function() {
          if (!_this.options.silent) {
            return _this.message('Attached to XBMC instance.');
          }
        };
      })(this));
      pubsub.on('connection:notification', this.notifications.delegate);
      if (this.options.connection != null) {
        this.setConnection(this.options.connection);
      }
    }

    XbmcApi.prototype.on = function(evt, callback) {
      debug('on', evt);
      return pubsub.on(evt, callback);
    };

    XbmcApi.prototype.emit = function(evt, data) {
      debug('emit', evt, data);
      return pubsub.emit(evt, data);
    };

    XbmcApi.prototype.loadModules = function() {
      var i, len, module, ref, results;
      debug('loadModules');
      ref = ['./Media', './Notifications', './Handlers', './Player', './Input'];
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        module = ref[i];
        results.push(require(module).mixin(this));
      }
      return results;
    };

    XbmcApi.prototype.setConnection = function(newConnection) {
      debug('setConnection');
      if (this.connection) {
        this.connection.close();
      }
      this.connection = newConnection;
      this.queue.forEach(function(item) {
        return this.send(item.method, item.params, item.dfd);
      });
      this.queue = [];
      return this.initialize();
    };

    XbmcApi.prototype.initialize = function() {
      var obj;
      debug('initialize');
      obj = this.send('Player.GetActivePlayers');
      return obj.then(this.handlers.players);
    };

    XbmcApi.prototype.send = function(method, params, dfd) {
      var connDfd, data;
      if (params == null) {
        params = {};
      }
      if (dfd == null) {
        dfd = null;
      }
      debug('send', method, JSON.stringify(params));
      data = {
        method: method,
        params: params
      };
      if (!this.connection) {
        data.dfd = defer();
        this.queue.push(data);
        return data.dfd.promise;
      }
      connDfd = this.connection.send(data);
      if (dfd) {
        connDfd.pipe(dfd.resolve);
      }
      return connDfd;
    };

    XbmcApi.prototype.scrub = function(data) {
      debug('scrub', data);
      if (data.thumbnail) {
        data.thumbnail = decodeURIComponent(data.thumbnail.replace(/^image:\/\/|\/$/ig, ''));
      }
      return data;
    };

    XbmcApi.prototype.message = function(message, title, displayTime, image) {
      var options;
      if (message == null) {
        message = '';
      }
      if (title == null) {
        title = null;
      }
      if (displayTime == null) {
        displayTime = 6000;
      }
      if (image == null) {
        image = null;
      }
      debug('message', message, title, displayTime, image);
      if (title == null) {
        title = this.options.agent || 'node-xbmc';
      }
      options = {
        message: message,
        title: title,
        displaytime: displayTime
      };
      if (image) {
        options.image = image;
      }
      return this.send('GUI.ShowNotification', options);
    };

    XbmcApi.prototype.connect = function() {
      debug('connection');
      if (this.connection) {
        if (this.connection.isActive()) {
          this.connection.close();
        }
        return this.connection.create();
      }
    };

    XbmcApi.prototype.disconnect = function(fn) {
      var ref;
      if (fn == null) {
        fn = null;
      }
      debug('disconnect');
      if ((ref = this.connection) != null ? ref.isActive() : void 0) {
        return this.connection.close(fn);
      }
      if (fn) {
        return fn();
      }
    };

    return XbmcApi;

  })();

  module.exports = XbmcApi;

}).call(this);
